# Avito-backend-task-2023

## Подготовка

Перед запуском приложения можно настроить пароль к базе данных, а также порты, на которых будут работать сервис и база данных, название базы данных и так далее (хотя изначально уже все настроено, может появиться необходимость изменить конфиг). 

Пароль можно поменять в файле .env.

Все, что связано с БД можно поменять в файле ```configs/config.yml```, а также в ```docker-compose.yml``` в соответствующих местах.

Кроме того, необходимо запустить Docker

## Сборка

Чтобы сбилдить проект, нужно ввести в терминале команду ```docker-compose up --build avito-backend-task-2023```. После некоторого количества времени запустятся контейнеры с postgres и самим сервисом. Если все хорошо, значит сервис запустился и можно делать запросы.

### Возможные ошибки при сборке

Если вдруг возникла ошибка, связанная с файлом ```wait-for-postgres.sh``` (такого быть не должно, но может появиться), то необходимо немного изменить файлы ```Dockerfile``` и ```docker-compose.yml```. В ```Dockerfile``` нужно удалить строку 11, а в ```docker-compose.yml``` убрать ```"./wait-for-postgres.sh db"``` из строки 6.

## Задание

Выполнены все обязательные задания, добавлен Swagger для API, а также выполнено дополнительное задание 1.

### Запросы

Все end-points находятся в группе ```/users-segmentation```

#### End-point ```/user``` необходим для работы с пользователями (создание/удаление)

CREATE USER: ***[POST] /user - создание пользователя (на вход подается информация о новом пользователе)***

Пример тела запроса:
```
{
  "name": "David",
  "username": "d4viid",
  "password": "h7dsg8d"
}
```

Пример ответа:
```
{
  "id": "2574c49b-4f15-49d0-8e27-b5741ecb43af" // uuid нового пользователя
}
```

DELETE USER: ***[DELETE] /user/:id - удаление пользователя (по его uuid)***

Пример запроса: ```localhost:8000/users-segmentation/user/2574c49b-4f15-49d0-8e27-b5741ecb43af```

Пример ответа:
```
{
  "status": "ok" // успешное удаление пользователя
}
```

#### End-point ```/segment``` необходим для работы с сегментами (создание/удаление)

CREATE SEGMENT: ***[POST] /segment - создание сегмента (на вход подается название новго сегмента)***

Пример тела запроса:
```
{
  "name": "AVITO_TEST_SEGMENT_1"
}
```

Пример ответа:
```
{
  "id": "2574c49b-4f15-49d0-8e27-b5741ecb43af" // uuid нового сегмента
}
```

DELETE SEGMENT: ***[DELETE] /segment - удаление сегмента (по его названию)***

Пример тела запроса:
```
{
  "name": "AVITO_TEST_SEGMENT_1"
}
```

Пример ответа:
```
{
  "status": "ok" // успешное удаление сегмента
}
```

#### End-point ```/users-segments``` необходим для добавление и удаления сегментов у пользователей

UPDATE USER SEGMENTS: ***[POST] /users-segments - добавление сегментов пользователю и удаление сегментов у пользователя по id***

Пример тела запроса:
```
{
    "id": "2574c49b-4f15-49d0-8e27-b5741ecb43af",
    "add": ["AVITO_TEST_SEGMENT_1", "AVITO_TEST_SEGMENT_3"],     // "add" можно не указывать в теле (тогда ничего не будет добавлено)
    "delete": ["AVITO_TEST_SEGMENT_4", "AVITO_TEST_SEGMENT_1"]   // "delete" можно не указывать в теле (тогда ничего не будет удалено)
}
```

Пример ответа:
```
{
  "status": "ok" // успешное добавление и удаление
}
```

GET USER SEGMENTS: ***[GET] /users-segments/:id - получение всех активных сегментов пользователя (по его id)***

Пример запроса: ```localhost:8000/users-segmentation/users-segments/574c49b-4f15-49d0-8e27-b5741ecb43af```

Пример ответа:
```
{
  "status": "ok" // успешное удаление сегмента
}
```

GET USER SEGMENTS LOG: ***[POST] /users-segments/logs - получение логов по изменению сегментов пользователей (начиная с введенной даты)***

Пример тела запроса: 
```
{
  "date": "2023-03" // запрос на получение логов начиная с 1 марта 2023 года
}
```

Пример ответа:
```
logs.csv           // будет скачан файл logs.csv с логами
```

#### End-point ```/swagger/index.html``` является Swagger файлом для API

## Детали реализации

* При добавлении/удалении сегментов пользователя сначала происходит удаление, а затем добавление (то есть при пересечении сегментов в add и delete по итогу эти сегменты будут добавлены).

* Была использована СУБД PostgreSQL
* Таблица users содержит в себе данные о пользователях (может быть с любыми полями, главное - должна содержать uuid)
* Таблица segments содержит в себе данные о сегментах (может быть с любыми полями, главное - должна содержать uuid)
* Таблица users_segments содержит в себе данные о пользователях и их активных сегментах
* Таблица users_segments_log содержит в себе данные об изменении сегментов пользователей
* Файл для создания табличек в БД - ```./init.sql```
